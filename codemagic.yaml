workflows:
  android_debug_apk_diag:
    name: Android Debug APK (deep diagnostics)
    environment:
      flutter: stable
      java: 17
    cache:
      cache_paths:
        - ~/.pub-cache
        - $HOME/.gradle/caches
        - $FCI_BUILD_DIR/build
    scripts:
      - echo "=== Versions ==="
      - flutter --version
      - java -version || true

      - echo "=== Ensure platform folders ==="
      - |
        if [ ! -d "android" ]; then
          echo "android/ missing -> running 'flutter create .'"
          flutter create .
        fi

      - echo "=== Prepare ==="
      - flutter clean
      - flutter pub get
      - flutter analyze || true

      - echo "=== Patch Gradle (Kotlin DSL) for CI stability ==="
      - |
        FILE="android/app/build.gradle.kts"
        if [ -f "$FILE" ]; then
          sed -i.bak 's/compileSdk\s*=\s*[^0-9]*/compileSdk = 34/' "$FILE" || true
          sed -i.bak 's/minSdk\s*=\s*[0-9]\+/minSdk = 23/' "$FILE" || true
          sed -i.bak 's/targetSdk\s*=\s*[0-9]\+/targetSdk = 34/' "$FILE" || true
          sed -i.bak 's/JavaVersion\.VERSION_[0-9]\+/JavaVersion.VERSION_17/g' "$FILE" || true
          sed -i.bak 's/jvmTarget\s*=\s*"[0-9]\+"/jvmTarget = "17"/' "$FILE" || true
        fi
        echo "----- android/app/build.gradle.kts -----"
        cat android/app/build.gradle.kts || true

      - echo "=== Gradle properties (AndroidX + memory) ==="
      - |
        GP="android/gradle.properties"
        touch "$GP"
        grep -q '^android.useAndroidX=' "$GP" || echo 'android.useAndroidX=true' >> "$GP"
        grep -q '^android.enableJetifier=' "$GP" || echo 'android.enableJetifier=true' >> "$GP"
        grep -q '^org.gradle.jvmargs=' "$GP" || echo 'org.gradle.jvmargs=-Xmx4g -Dkotlin.daemon.jvm.options=-Xmx2g' >> "$GP"
        echo "----- android/gradle.properties -----"
        cat "$GP" || true

      - echo "=== Build with Gradle directly (more diagnostics) ==="
      - |
        set -o pipefail
        cd android
        ./gradlew assembleDebug --stacktrace --info 2>&1 | tee ../gradle-debug.log
        cd ..
        # Also try Flutter (sometimes nicer error grouping)
        flutter build apk --debug -v 2>&1 | tee build-verbose.log || true

    artifacts:
      - gradle-debug.log
      - build-verbose.log
      - build/app/outputs/flutter-apk/app-debug.apk
